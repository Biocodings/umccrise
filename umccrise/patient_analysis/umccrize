#!/usr/bin/env python
import os
from os.path import isfile, join, dirname, abspath
import click
from umccrise import patient_analysis
from ngs_utils.call_process import run


@click.command()
@click.argument('bcbio_project', type=click.Path(exists=True))
@click.argument('rule', nargs=-1)
@click.option('-o', 'output_dir', type=click.Path())
@click.option('-j', 'jobs', default=1)
@click.option('-s', '--sample', 'sample')
@click.option('-s', '--batch', 'batch')
@click.option('-u', '--upload-pcgr/--no-upload-pcgr', 'upload_pcgr', default=False)
def main(bcbio_project, rule=list(), output_dir=None, jobs=1, sample=None, batch=None, upload_pcgr=False):
    bcbio_project = os.path.abspath(bcbio_project)
    conf = f'run_dir={bcbio_project}'
    if sample:
        conf += f' sample={sample}'
    if batch:
        conf += f' batch={batch}'
    if upload_pcgr:
        conf += f' upload_pcgr=True'

    cmd = (
        f'snakemake ' +
        f'{" ".join(rule)} ' +
        f'--snakefile {join(patient_analysis.package_path(), "Snakefile")} ' +
        f'--printshellcmds ' +
       (f'--directory {output_dir} ' if output_dir else ' ') +
        f'-j {jobs} ' +
        f'--config {conf} '
    )
    run(cmd)


if __name__ == '__main__':
    main()
