""" UMCCR post-bcbio patient analysis workflow
"""
import os
from os.path import join, abspath, dirname, isfile, basename, splitext
from ngs_utils.file_utils import splitext_plus, verify_file, verify_dir
from ngs_utils.bcbio import BcbioProject
from ngs_utils.logger import critical, info
from python_utils.hpc import get_loc, get_ref_file
from ngs_utils.reference_data import get_key_genes_bed

shell.executable(os.environ.get('SHELL', 'bash'))
shell.prefix("")
threads_max = 32  # Use up to 32 cores at once, if available


is_spartan = get_loc().name == 'spartan'
is_raijin = get_loc().name == 'raijin'
is_hpc = is_spartan or is_raijin
upload_proxy = ''
if is_spartan:
    upload_proxy = 'HTTPS_PROXY=http://wwwproxy.unimelb.edu.au:8000 '

upload_igv = is_hpc


def prep_inputs(config_):
    run = BcbioProject(config_.get('bcbio_project', abspath(os.getcwd())))
    run.project_name = splitext(basename(run.bcbio_yaml_fpath))[0]

    key_genes_bed = get_key_genes_bed(run.genome_build)

    ############################################
    #### Reference files provided directly? ####
    ############################################
    ref_fa = config_.get('ref_fasta')
    truth_regions = config_.get('truth_regions')
    pon_dir = config_.get('panel_of_normals')
    pcgr_installation = config_.get('pcgr')

    ##################################################
    #### Bcbio reference genomes folder provided? ####
    ##################################################
    bcbio_genomes_dir = config_.get('bcbio_genomes')
    if bcbio_genomes_dir:
        # Looking for reference fasta
        for fp in [
            join(bcbio_genomes_dir, f'Hsapiens/{run.genome_build}/seq/{run.genome_build}.fa'),
            join(bcbio_genomes_dir, f'{run.genome_build}/seq/{run.genome_build}.fa'),
            join(bcbio_genomes_dir, f'seq/{run.genome_build}.fa')]:
            if isfile(fp):
                ref_fa = fp
        if not ref_fa:
            critical(f'Not found {run.genome_build}.fa in bcbio genomes directory {bcbio_genomes_dir}')

        # Looking for truth regions
        for fp in [
            join(bcbio_genomes_dir, f'Hsapiens/{run.genome_build}/validation/giab-NA12878/truth_regions.bed'),
            join(bcbio_genomes_dir, f'{run.genome_build}/validation/giab-NA12878/truth_regions.bed'),
            join(bcbio_genomes_dir, f'validation/giab-NA12878/truth_regions.bed')]:
            if isfile(fp):
                truth_regions = fp
        if not truth_regions:
            critical(f'Not found GiaB truth regions in bcbio genomes directory {bcbio_genomes_dir}')

    #################################################################
    #### Reference files not provided, but we are on known host? ####
    #################################################################
    if not ref_fa:
        ref_fa = get_ref_file(run.genome_build)
    if not truth_regions:
        truth_regions = get_ref_file(run.genome_build, ['truth_sets', 'giab', 'bed'])
    if not pon_dir:
        pon_dir = get_ref_file(run.genome_build, 'panel_of_normals_dir')
    if not pcgr_installation:
        pcgr_installation = get_loc().pcgr_dir

    ###########################################################
    #### Done looking for refernece files, now some checks ####
    ###########################################################
    truth_regions = verify_file(truth_regions, is_critical=True, description='GiaB truth regions')

    ref_fa = verify_file(ref_fa, is_critical=True, description='Reference fasta')
    verify_file(ref_fa + '.fai', is_critical=True, description='Reference fasta fai index')

    if pon_dir:
        verify_dir(pon_dir, 'Panel of normals directory', is_critical=True)
        verify_file(join(pon_dir, 'panel_of_normals.snps.vcf.gz'), is_critical=True, description='Panel of normals SNPs file in user provided folder')
        verify_file(join(pon_dir, 'panel_of_normals.snps.vcf.gz.tbi'), is_critical=True, description='Please index panel of normal files with tabix')
        verify_file(join(pon_dir, 'panel_of_normals.indels.vcf.gz'), is_critical=True, description='Panel of normals indels file in user provided folder')
        verify_file(join(pon_dir, 'panel_of_normals.indels.vcf.gz.tbi'), is_critical=True, description='Please index panel of normal files with tabix')

    if pcgr_installation:
        verify_dir(pcgr_installation, is_critical=True, description='PCGR installation directory')
        verify_dir(join(pcgr_installation, 'data'), is_critical=True, description='PCGR data directory')
        info('Running with PCGR')

    #############################
    #### Non-path parameters ####
    #############################
    # Batch objects index by tumor sample names
    batches = [b for b in run.batch_by_name.values() if not b.is_germline()]
    include_names = config_.get('batch') or config_.get('sample')
    if include_names:
        include_names = include_names.split(',')
        selected_batches = [b for b in batches if b.name in include_names
                                               or b.tumor.name in include_names
                                               or b.name + '__' + b.tumor.name in include_names]
        if len(selected_batches) == 0:
            critical(f'Error: could not find a batch or a sample with the name(s): {", ".join(include_names)}. '
                     f'Known batches: {list(b.name for b in batches)}, '
                     f'known samples: {list(b.tumor.name for b in batches)}')
        batches = selected_batches
    exclude_names = config_.get('exclude')
    if exclude_names:
        exclude_names = exclude_names.split(',')
        selected_batches = [b for b in batches if b.name not in exclude_names
                                              and b.tumor.name not in exclude_names
                                              and b.name + '__' + b.tumor.name not in include_names]
        if len(selected_batches) == 0:
            critical(f'Error: no samples left with the exclusion of batch/sample name(s): {", ".join(exclude_names)}.')
        batches = selected_batches
        info(f'Excluding sample/batch name(s): {", ".join(exclude_names)}.')

    batch_by_name = {b.name + '__' + b.tumor.name: b for b in batches}

    return run, batch_by_name, ref_fa, truth_regions, pon_dir, key_genes_bed, pcgr_installation


run, batch_by_name, ref_fa, truth_regions, pon_dir, key_genes_bed, pcgr_installation = prep_inputs(config)
GERMLINE_SUFFIX = '-germline'
if any(isfile(join(run.date_dir, batch_by_name[b].normal.name + '-ensemble-annotated.vcf.gz'))
       for b in batch_by_name.keys()):
    GERMLINE_SUFFIX = ''


rule all:
    input: 'umccrised.done'
    # A trick to avoid duplicating all input paths in the top "all" rule which has to be defined on top.

# TODO: try subworkflows here? http://snakemake.readthedocs.io/en/stable/snakefiles/modularization.html#sub-workflows
"""
subworkflow small_variants:
    workdir: 'small_variants'
    snakefile: 'Snakefile.small_variants'

rule all:
    input:  small_variants('small_variants.done')
    output: ...
    shell:  ...
"""
# Or maybe it's not reasonable and not doable here since the input file is a phony .done, and also we depend on config in subworkflows


include: "small_variants.smk"
include: "coverage.smk"
include: "structural.smk"
include: "igv.smk"
include: "pcgr.smk"
include: "rmd.smk"


localrules: multiqc, copy_logs, umccrise


rule multiqc:  # {}
    input:
        join(run.date_dir, 'multiqc/multiqc_report.html')
    output:
        run.project_name + '-multiqc_report.html'
    shell:
        'cp {input} {output}'
        # generate proper mutliqc_umccrise



## Additional information
# TODO: link it to MultiQC
rule copy_logs:  # {}
    input:
        join(run.date_dir, 'data_versions.csv'), 
        join(run.date_dir, 'programs.txt'), 
        run.config_dir
    output:
        'log/' + run.project_name + '-data_versions.csv',
        'log/' + run.project_name + '-programs.txt',
        'log/' + run.project_name + '-config'
    shell:
        'cp -r {input[0]} {output[0]} && cp -r {input[1]} {output[1]} && cp -r {input[2]} {output[2]}'


rule umccrise:
    input:  # Copy here inputs of the "milestone" rules (rules without output defined in the end of each Snakemake.* file)
        rules.multiqc.output,
        rules.copy_logs.output,
        rules.coverage.output,
        rules.structural.output,
        rules.small_variants.output,
        rules.rmd.output,
        (rules.pcgr.output if pcgr_installation else rules.pcgr_prep.output),
        rules.igv.output
    output:
        temp(touch('umccrised.done'))
